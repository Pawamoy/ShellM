#!/bin/bash

## \brief creates a new script in your shellm/usr/bin directory
## \require coreutils

## \desc This script creates a new file in your shellm/usr/bin directory,
## makes it executable, writes some lines in it, like the shebang
## #!/bin/bash, documentation lines and others, then
## opens it for you to write the rest of the code.

include core/shellman.sh
include core/init/data.sh

[ $# -eq 0 ] && usage
data_dir=$(init_data)

main() {
  case $1 in
    ## \option -h, --help
    ## Prints this help and exit
    -h|--help) shellman -t "$0"; exit 0 ;;
  esac

  # Test if the script already exists
  # shellcheck disable=SC2154
  if [ -f "${SHELLM_USR}/bin/$1" ]; then
    echo "shellm: new: $1 already exists in ${SHELLM_USR}/bin" >&2
    exit 1
  fi

  # Copy the template
  if [ -z "$2" ]; then
    cp "${data_dir}/default" "${SHELLM_USR}/bin/$1"
  else
    if [ -f "${data_dir}/$2" ]; then
      cp "${data_dir}/$2" "${SHELLM_USR}/bin/$1"
    else
      echo "shellm: new: template $2 does not exist in ${data_dir}" >&2
      exit 2
    fi
  fi

  # Make it executable
  chmod +x "${SHELLM_USR}/bin/$1"

  # Open the file
  vim "${SHELLM_USR}/bin/$1"
}

## \usage shellm-new FILENAME [TEMPLATE] | -h
main "$@"
